<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=windows-1252">
    <title>vcio2 - Kernel driver to access Raspberry Pi VideoCore IV GPU without root privileges</title>
    <meta content="Marcel Müller" name="author">
    <meta content="Raspberry Pi BCM2835 BCM2708 QPU DKMS vcio" name="keywords">
    <link rel="stylesheet" href="infstyle.css" type="text/css">
  </head>
  <body>
    <h1>vcio2 - Kernel driver to access Raspberry Pi VideoCore IV GPU without root privileges</h1>
    <p class="abstract">When using Raspberry Pi's GPU from user space (e.g. <a href="https://www.raspberrypi.org/accelerating-fourier-transforms-using-the-gpu/">hello_fft</a>)
      with the built-in vcio driver in the RPi kernel you need to have root privileges for every application.<br>
      The goal of the vcio2 driver is to come around this restriction. Furthermore vcio2 keeps track of the resources and performs
      some clean-up if the application is interrupted.</p>
    <p><a class="nobr" href="#features">&#9660; Features &amp; Limitations</a>, <a class="nobr" href="#install">&#9660; Installation
        instructions</a>, <a class="nobr" href="#usage">&#9660; Using the driver</a>, <a class="nobr" href="guide.html#sample">&#9654; Sample
        code</a>, <a class="nobr" href="guide.html">&#9654; Programming guide</a>, <a class="nobr" href="APIref.html">&#9654; API reference</a>,
      <a class="nobr" href="#contact">&#9660; Contact</a></p>
    <h2><a name="download"></a>Download &amp; history</h2>
    <p>Download <a href="../vcio2.tar.bz2">DKMS kernel module, an example and this documentation</a></p>
    <dl>
      <dt>V0.2</dt>
      <dd>Rewrote the driver to support newer RPi kernels.</dd>
      <dt>V0.1</dt>
      <dd>First public release.</dd>
    </dl>
    <h2><a name="features"></a>Features</h2>
    <ul>
      <li><b>No root</b> privilege <b>required</b> to use the GPU.</li>
      <li><b>Automatic cleanup of resources</b> like GPU memory on application termination, e.g. crash or <tt>SIGBREAK</tt>.</li>
      <li><b>Share the GPU</b> by multiple applications.</li>
      <li>Enable and disable the GPU automatically.</li>
      <li>Some protection against invalid memory access.</li>
      <li><b>Supports</b> Raspberry Pi models: <b>RPi 1, RPi 2, RPi 3</b> (all variants)</li>
    </ul>
    <h3>Limitations</h3>
    <ul>
      <li><strong>vcio2 does not validate the shader code. It is still a major security issue to permit users to use the vcio2
          device.</strong> It just protects against some accidental misbehavior. <em>This will never change</em>, since VideoCore
        IV has no MMU. But access to vcio2 is no more risky than access to the vcio device that Raspbian grants to the video group
        by default.</li>
      <li><b>Power management events</b> (e.g. ARM clock changes) <b>are blocked</b> during execution of GPU code.<br>
        This is an restriction of the RPi firmware. It simply uses the same mailbox channel for system health and GPU execution.</li>
      <li><b>No two applications can run GPU code concurrently</b> even if they do not use all QPUs.<br>
        This is due to some global GPU resources like semaphores that cannot be reasonably shared.</li>
      <li><b>Closing the device</b> or unlock of memory <b>leaves invalid memory mappings</b> in the current processes virtual
        address space.<br>
        This is a bug. I simply did not find a kernel function to revoke memory mappings so far.</li>
    </ul>
    <h3>TODOs</h3>
    <ul>
      <li> Support for <tt>qpu_enable</tt> to explicitly control the QPU power. </li>
      <li> Power off the QPU after execution timeouts for better error recovery. </li>
      <li> Implement some higher level functions that do memory allocations, locking and mapping in one step.</li>
      <li>Provide functions to access the performance counters.</li>
    </ul>
    <ul>
    </ul>
    <h2><a name="install"></a>Installation instructions</h2>
    <h3>Prerequisites</h3>
    <ul>
      <li>Install <b><tt>dkms</tt> package</b> if not yet done. (<tt>sudo apt-get install dkms</tt>)</li>
      <li>Install <b>Linux kernel headers</b>. (<tt>sudo apt-get install</tt><tt> raspberrypi-kernel-headers</tt>)</li>
      <li>In fact I only tested with kernel <tt>4.19</tt> so far but it is likely to work with other kernels too.</li>
    </ul>
    <h3>Driver permissions</h3>
    <ul>
      <li>Copy the file <tt>extra/10-vcio2.rules</tt> to <tt>/etc/udev/rules.d</tt>.<br>
        This will grant access to the <tt>/dev/vcio2</tt> device to members of the <tt>video</tt> group.</li>
    </ul>
    <ul>
    </ul>
    <h3>Build and install the driver</h3>
    <ul>
      <li>Unpack the <a href="#download">package</a> above to some folder.</li>
      <li>Open a shell.</li>
      <li>Go to the folder where the files are extracted. (not to sub folder <tt>src</tt>)</li>
      <li><tt>sudo make install</tt></li>
    </ul>
    <p>Normally this should build the kernel module using DKMS, install it for the currently running kernel, setup the driver for
      autostart and load the driver. So you are ready to use immediately.</p>
    <p>If it does not work, have a look at the error messages on the screen as well as <tt>/var/dkms/vcio2/0.2/build/make.log</tt>
      (compilation) and <tt>/var/log/syslog</tt> (loading).</p>
    <h3>Remove the driver</h3>
    <ul>
      <li>Open a shell.</li>
      <li>Go to the folder where the files are extracted. (Not to sub folder <tt>src</tt>) </li>
      <li><tt>sudo make remove</tt></li>
    </ul>
    <p>This will unload the kernel module and uninstall it.</p>
    <h2><a name="usage"></a>Using the driver</h2>
    <p>As soon as the driver is loaded successfully, a new device <tt>/dev/vcio2</tt> appears.</p>
    <p> This is the new device which offers new <a href="#features">features</a>. Using this device requires changes to the source
      code of the application. See the <a href="APIref.html">API reference</a> and especially the <a href="guide.html#migrate">migration
        guide</a>.</p>
    <p>You might want to grant access to this device to some group to prevent the need of root privileges to use the GPU. I.e. <tt>chmod
        660</tt> and <tt>chgrp</tt>. You might also set up a <i>udev rule</i> to set this permissions automatically. (Who knows
      how to do this?)<em><br>
        Note that access to this device is still a major security hole</em>, suitable to gain root privileges.</p>
    <p>See <a href="guide.html">vcio2 programming guide</a> for further details.</p>
    <p>If someone thinks that it should be part of the RPi kernel and knows how to contribute, let me know.</p>
    <h2><a name="contact"></a>Contact</h2>
    <p>Comments, ideas, bugs, improvements to <i>raspi at maazl dot de</i>.</p>
  </body>
</html>
